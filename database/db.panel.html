<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fancytree ar rediģēšanu un saglabāšanu</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.38.2/dist/skin-win8/ui.fancytree.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery.fancytree@2.38.2/dist/jquery.fancytree-all-deps.min.js"></script>
</head>

  <style>
    /* Blokam, kur būs koks un pogas */
        #tree-buttons-wrapper {
        display: flex;
        flex-direction: column;
        width: 420px;
        border: 1px solid #000;
        padding: 10px;
        box-sizing: border-box;
        height: 800px;
        overflow: hidden;
        }
        

        #tree {
        flex-grow: 1;       /* aizņem visu pieejamo vietu */
        width: 100%;
        max-width: 100%;
        overflow-y: auto;  /* scroll tikai vertikāli */
        overflow-x: hidden; /* lai nekas nepārietu horizontāli */
        border: 1px solid #ccc;
        padding: 5px;
        min-height: 100px;
        box-sizing: border-box;
        }

        #buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;                  /* atstarpes starp pogām */
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: visible;  /* scroll nav */
        }

        #buttons button {
        flex-grow: 1;              /* lai pogas stiepjas vienmērīgi, vari noņemt, ja negribi */
        min-width: 90px;
        margin: 0;
        padding: 6px 12px;
        cursor: pointer;
        box-sizing: border-box;
        }
    h2 {
        max-width: 420px;      /* jāatbilst #container platumam */
        box-sizing: border-box;
        margin: 0 0 10px 0;    /* mazliet atstarpi zem headera */
        word-break: break-word; /* lai teksts labi lūzt */
        }
        /* Konteiners, kur koks ar pogām un tabula blakus */
        #main-wrapper {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        max-width: 100%;
        }

       
        /* Tabulas konteiners */
        #tree-table {
        flex-grow: 1;  /* aizņem visu atlikušo platumu */
        border: 1px solid #ccc;
        padding: 10px;
        overflow: auto;
        box-sizing: border-box;
        min-width: 300px;
        font-size: 14px;
        }

        /* Piemērs tabulas stilam, kas tiks ģenerēta */

        #tree-table table {
        border-collapse: collapse;
        width: 100%;
        }

        #tree-table th, #tree-table td {
        border: 1px solid #ccc;
        padding: 4px 8px;
        text-align: left;
        white-space: nowrap;
        }

        #tree-table th {
        background-color: #f4f4f4;
        font-weight: bold;
        }

        #tree-table tr:nth-child(even) {
        background-color: #fafafa;
        }
        #dragbar {
        width: 5px;
        cursor: col-resize;
        background-color: #ccc;
        /* Ja gribi, lai josla stiepjas līdz augšai un apakšai */
        align-self: stretch;  
        /* Papildus vari dot arī hover efektu */
        }
  </style>
  <body>
  <h2>Izvēlētās sadaļas ar mapēm un apakšelementiem</h2>
    <div id="main-wrapper">
    <!-- Koks un pogas vertikāli -->
      <div id="tree-buttons-wrapper">
        <div id="tree"></div>
    <!-- pogas mezglu pievienošanai un dzēšanai  -->
            <div id="buttons">
                <button id="toggle-folder">Pārslēgt mape/fails</button>
                <button id="add-root">Pievienot jaunu sakni</button>
                <button id="add-node">Pievienot mezglu</button>
                <button id="add-folder">Pievienot mapi</button>
                <button id="remove-node">Dzēst izvēlēto mezglu</button>
                <button id="save-server">Saglabāt serverī</button>
                <button id="reset-tree">Restartēt koku</button>
            </div>
        </div>
        <!-- Šī ir drag bar josla -->
            <div id="dragbar"></div>
    <!-- Tabulas zona (atsevišķa no koka) -->
            <div id="tree-table" >
                <!-- Tabula tiks ģenerēta šeit -->
            </div>        
    </div>
  <script>
   
    // Šis skripts tiek izpildīts, kad DOM ir gatavs, jo tas ir pirms </body>
   $(function() {
  // 1) Inicializē fancytree
        // Funkcija, kas ģenerē nākamo unikālo saknes ID formātā SAD_X
        function getNextRootId(tree) {
            var maxNum = 0;
            var rootNode = tree.getRootNode();
            var children = rootNode.children || []; // ja nav bērnu, izmanto tukšu masīvu
            children.forEach(function(n) {
                if (n.key && n.key.startsWith("SAD_")) {
                    var num = parseInt(n.key.replace("SAD_", ""));
                    if (!isNaN(num) && num > maxNum) {
                        maxNum = num;
                    }
                }
            });
            return "SAD_" + (maxNum + 1);
        }

        // Funkcija, kas ģenerē nākamo ID apakšmezgliem, piemēram SAD_1_1, SAD_1_2, utt.
        function getNextChildId(parentNode) {
            var prefix = parentNode.key;  // piemēram "SAD_1_1"
            var maxNum = 0;

            if (parentNode.children) {
                parentNode.children.forEach(function(child) {
                    if (child.key && child.key.startsWith(prefix + "_")) {
                        var parts = child.key.split("_");
                        var prefixParts = prefix.split("_");
                        // Pārbauda, ka bērna atslēgai ir tieši viens līmenis vairāk
                        if (parts.length === prefixParts.length + 1) {
                            var num = parseInt(parts[parts.length - 1]);
                            if (!isNaN(num) && num > maxNum) {
                                maxNum = num;
                            }
                        }
                    }
                });
            }

    return prefix + "_" + (maxNum + 1);
}
        // 1. Funkcija, kas pārveido fancytree datus par JSON, lai saglabātu localStorage
        function saveTree() {
            // Iegūst visu koku kā vienu objektu JSON formātā
            var tree = $("#tree").fancytree("getTree");
            var treeData = tree.toDict(true); // true - saglabā arī bērnus
            // Saglabā stringā localStorage
            localStorage.setItem("myFancytreeData", JSON.stringify(treeData));
        }
        // Poga, kas pievieno jaunu sakni ROOT līmenī
        $("#add-root").click(function() {
            var tree = $("#tree").fancytree("getTree");
            var rootNode = tree.getRootNode();
            var newId = getNextRootId(tree); // ģenerē ID
            var newNode = rootNode.addChildren({
                title: "Jauna sakne (" + newId + ")", // parāda iekavās
                folder: true,
                key: newId,
                data: {prefix: newId} // ļoti svarīgi
            });
            rootNode.setExpanded(true);
            newNode.editStart(); // ļauj uzreiz rediģēt nosaukumu
            saveTree();
        });
        // Pievieno jaunu apakšmezglu
            function addChildNode() {
                var tree = $("#tree").fancytree("getTree");
                var node = tree.getActiveNode();
                if (!node) { alert("Izvēlies mezglu!"); return; }

                var prefix = node.data?.prefix || node.key; // ņem prefiksu no saknes
                var newId = getNextIdForPrefix(tree, prefix);

                var newNode = node.addChildren({
                    title: "Jauns apakšmezgls (" + newId + ")",
                    key: newId,
                    folder: false
                });

                node.setExpanded(true);
                newNode.editStart();
                saveTree();
            }
        // 2. Inicializē fancytree, ielādējot datus no localStorage vai sākotnējo avotu
        var savedData = localStorage.getItem("myFancytreeData");
        var initialSource = savedData ? JSON.parse(savedData) : [
            {
            title: "Saknes mape 1",
            key: "SAD_1",
            folder: true,
            expanded: true,
            data: {prefix: "SAD_1"},  // <-- Šeit pievieno prefiksu saknes mezglam
            children: [
                {
                title: "Kategorija A",
                key: "SAD_1_1",
                folder: true,
                expanded: true,
                children: [
                    { title: "Apakšelements A1", key: "SAD_1_1_1" ,folder: false },
                    { title: "Apakšelements A2", key: "SAD_1_1_2" ,folder: false }
                ]
                },
                {
                title: "Kategorija B",
                key: "SAD_1_2",
                folder: true,
                expanded: true,
                children: [
                    { title: "Apakšelements B1", key: "SAD_1_2_1" ,folder: false }
                ]
                },
                {
                title: "Kategorija C",
                key: "SAD_1_3",
                folder: true,
                expanded: true,
                children: [
                    { title: "Apakšelements C1", key: "SAD_1_3_1" ,folder: false },
                    { title: "Apakšelements C2", key: "SAD_1_3_2" ,folder: false }
                ]
                }
            ]
            },
            {
            title: "Saknes mape 2",
            key: "SAD_2",
            folder: true,
            expanded: true,
            data: {prefix: "SAD_2"},  // <-- Šeit pievieno prefiksu saknes mezglam
            children: [
                {
                title: "Kategorija A",
                key: "SAD_2_1",
                folder: true,
                expanded: true,
                children: [
                    { title: "Apakšelements A1", key: "SAD_2_1_1" ,folder: false },
                    { title: "Apakšelements A2", key: "SAD_2_1_2" ,folder: false }
                ]
                },
                {
                title: "Kategorija B",
                key: "SAD_2_2",
                folder: true,
                expanded: true,
                children: [
                    { title: "Apakšelements B1", key: "SAD_2_2_1" ,folder: false }
                ]
                },
                {
                title: "Kategorija C",
                key: "SAD_2_3",
                folder: true,
                expanded: true,
                children: [
                    { title: "Apakšelements C1", key: "SAD_2_3_1" ,folder: false },
                    { title: "Apakšelements C2", key: "SAD_2_3_2" ,folder: false }
                ]
                }
            ]
            }
        ];
    $("#tree").fancytree({
        checkbox: true,
        extensions: ["dnd5", "edit"],
        dnd5: {
            preventRecursion: true,
            dragStart: function(node, data) { return true; },
            dragEnter: function(node, data) { return true; },
            dragDrop: function(node, data) {
            data.otherNode.moveTo(node, data.hitMode);
            saveTree();  // saglabā izmaiņas pēc pārvietošanas
            }
        },
        edit: {
            triggerStart: ["clickActive", "f2", "shift+click"],
            beforeEdit: function(event, data) {
            // Var ierobežot rediģēšanu pēc vajadzības
            return true;
            },
            save: function(event, data) {
            data.node.setTitle(data.input.val());
            },
            close: function(event, data) {
            if (data.save) {
                saveTree(); // saglabā izmaiņas pēc rediģēšanas
                }
            }                    
        },
        
         source: initialSource  // Šeit jābūt source!
        });
            // 2) Tagad iegūsti tree objektu
        var fancytree = $("#tree").fancytree("getTree");

        // 3) ID generesana
         // Šeit ievieto getRootPrefix un getNextIdForPrefix funkcijas:
           function getRootPrefix(node) {
            var current = node;
            while(current && !current.data?.prefix) {
                current = current.getParent();
            }
            if(current && current.data?.prefix) {
                return current.data.prefix;
            }
            // Ja neatrod, izmanto pašreizējā mezgla key vai default
            return node.key || "root";
                }

            function getNextIdForPrefix(tree, prefix) {
                var maxNum = 0;
                tree.visit(function(n) {
                    if(n.key && n.key.startsWith(prefix + "_")) {
                        var parts = n.key.split("_");
                        var prefixParts = prefix.split("_");
                        if (parts.length === prefixParts.length + 1) {
                        var num = parseInt(parts[parts.length - 1]);
                        if(!isNaN(num) && num > maxNum) {
                            maxNum = num;
                        }
                        }
                    }
                });
                return prefix + "_" + (maxNum + 1);
            }

            function addChildNode() {
                var tree = $("#tree").fancytree("getTree");
                var node = tree.getActiveNode();  // iegūst aktīvo/izvēlēto mezglu
                if (!node) {
                    alert("Izvēlies mezglu, kam pievienot apakšmezglu!");
                    return;
                }
                var prefix = node.key;
                var newId = getNextIdForPrefix(tree, prefix);
                var newNode = node.addChildren({
                    title: "Jauns apakšmezgls (" + newId + ")",
                    key: newId,
                    folder: false
                });
                node.setExpanded(true);
                newNode.editStart();
                saveTree();
            }
            // 3) Sūta uz PHP failu
            function sendTreeToServer() {
                var tree = $("#tree").fancytree("getTree");
                var treeData = tree.toDict(true);
                var jsonData = JSON.stringify(treeData);

                $.ajax({
                    url: 'db_test.php',
                    type: 'POST',
                    data: { treeJson: jsonData },
                    success: function(response) {
                        alert("Dati veiksmīgi saglabāti!");
                        console.log(response);
                    },
                    error: function(xhr, status, error) {
                        alert("Kļūda saglabājot datus!");
                        console.error(error);
                    }
                });
            }
        // 3) Pievieno pogu klikšķu apstrādi
            $("#toggle-folder").click(function() {
                var tree = $("#tree").fancytree("getTree");
                var node = tree.getActiveNode();
                if (!node) {
                    alert("Lūdzu, izvēlies mezglu!");
                    return;
                }
                if (node.isRoot()) {
                    alert("Saknes mezglu nevar pārslēgt!");
                    return;
                }

                // Pārbauda bērnus
                var children = node.getChildren() || [];
                var childrenCount = children.length;

                // Ja ir bērnu, kas ir mape vai bērnu vairāk par 1, tad neļauj pārslēgt uz failu
                var hasFolderChild = children.some(function(c) { return c.folder; });

                if (childrenCount > 1 || hasFolderChild) {
                    alert("Nevar pārslēgt par failu, jo zem mapes ir apakšmapes vai vairāki mezgli.");
                    return;
                }

                // Tagad var pārslēgt
                // Pārslēdz folder statusu
                node.folder = !node.folder;

                // Ja tagad tas ir mape, saglabā stāvokli expanded
                if (node.folder) {
                    node.expanded = true;
                }

                node.render(); // Atsvaidzina mezglu

                saveTree();
            });
        
         $("#add-node").click(function(){
            var node = fancytree.getActiveNode();
            if(!node){
            alert("Lūdzu izvēlies mezglu, pie kura pievienot jaunu mezglu!");
            return;
            }
            if(!node.folder){
            alert("Jaunu mezglu var pievienot tikai mapēm!");
            return;
            }
            var prefix = node.key;
            var newKey = getNextIdForPrefix(fancytree, prefix);
            var newNode = node.addChildren({
            title: "Jauns mezgls[" + newKey + "]",
            folder: false,
            key: newKey,
            
            });
            node.setExpanded(true);  // Paplašina vecāku mezglu, lai redzētu bērnu
            newNode.editStart();
            saveTree();  // saglabā pēc pievienošanas
        });
        $("#add-folder").click(function(){
            var node = fancytree.getActiveNode();
            if(!node){
            alert("Lūdzu izvēlies mezglu, pie kura pievienot jaunu mapi!");
            return;
            }
            if(!node.folder){
            alert("Jaunu mapi var pievienot tikai mapēm!");
            return;
            }
            var prefix =  node.key;
            var newKey = getNextIdForPrefix(fancytree, prefix);
            var newFolder = node.addChildren({
            title: "Jauna mape [" + newKey + "]",
            folder: true,
            key:newKey,
            data: { prefix: newKey }  // šeit pievieno prefiksu, lai ID ģenerēšana strādātu dziļākos līmeņos
            });
            node.setExpanded(true);  // Paplašina vecāku mezglu, lai redzētu bērnu
            newFolder.editStart();  
            // Ja vēlies, lai uzreiz var rediģēt nosaukumu
            saveTree();  // saglabā pēc pievienošanas
        });

       
        $("#remove-node").click(function(){
            var node = fancytree.getActiveNode();
            if(!node){
            alert("Lūdzu izvēlies mezglu, kuru dzēst!");
            return;
            }
            if(node.isRoot()){
            alert("Saknes mezglu dzēst nevar!");
            return;
            }
            node.remove();
            saveTree();  // saglabā pēc pievienošanas
        });
        $("#save-server").click(function() {
            sendTreeToServer();
        });
        });

        // 4) Pievieno drag bar funkcionalitāti
            // Šī ir drag bar josla, kas ļauj mainīt koka un tabulas platumu
        const dragbar = document.getElementById("dragbar");
            const treeWrapper = document.getElementById("tree-buttons-wrapper");

            dragbar.addEventListener("mousedown", function(e) {
            e.preventDefault();
            document.addEventListener("mousemove", resize);
            document.addEventListener("mouseup", stopResize);
            });

            function resize(e) {
            // Pārbauda, lai platums nav pārāk mazs vai liels
            const newWidth = e.clientX;
            if(newWidth > 150 && newWidth < window.innerWidth - 200) {
                treeWrapper.style.width = newWidth + "px";
            }
            }

            function stopResize() {
            document.removeEventListener("mousemove", resize);
            document.removeEventListener("mouseup", stopResize);
            }

        // Ģenerē tabulu
            function buildTableFromTree(tree) {
                const maxDepth = 5; // cik dziļi līmeņi izvadīt (nosaukums+id kolonnām)
                let rows = [];

                // Rekursīva funkcija, kas veido ceļus (rindas)
                function walk(node, path) {
                // Path satur objektus ar title un key
                const newPath = path.concat([{title: node.title, key: node.key}]);

                if(!node.hasChildren()) {
                    rows.push(newPath);
                } else {
                    if(node.children && node.children.length) {
                    node.children.forEach(child => walk(child, newPath));
                    } else {
                    // Ja mape bez bērniem - uzreiz pieraksta
                    rows.push(newPath);
                    }
                }
                }

                // Sāk no koka saknes (root ir "invisible" mezgls)
                tree.getRootNode().children.forEach(rootNode => {
                walk(rootNode, []);
                });

                


                // Izveidojam tabulas headeru ar manuāliem nosaukumiem
                //let headerHtml = "<tr>";
                //headerHtml += `<th>Saknes nosaukums</th><th>Saknes ID</th>`;
                //headerHtml += `<th>1. līmeņa nosaukums</th><th>1. līmeņa ID</th>`;
                //headerHtml += `<th>2. līmeņa nosaukums</th><th>2. līmeņa ID</th>`;
                //headerHtml += `<th>3. līmeņa nosaukums</th><th>3. līmeņa ID</th>`;
                //headerHtml += `<th>4. līmeņa nosaukums</th><th>4. līmeņa ID</th>`;
                //headerHtml += "</tr>";

                // Izveidojam tabulas headeru ar pāriem Nosaukums + ID
                let headerHtml = "<tr>";
                for(let i=0; i<maxDepth; i++) {
                headerHtml += `<th>Nosaukums L${i+1}</th><th>ID L${i+1}</th>`;
                }
                headerHtml += "</tr>";

                // Izveidojam rindas
                let bodyHtml = "";
                rows.forEach(path => {
                bodyHtml += "<tr>";
                for(let i=0; i<maxDepth; i++) {
                    if(i < path.length) {
                    bodyHtml += `<td>${path[i].title}</td><td>${path[i].key}</td>`;
                    } else {
                    bodyHtml += "<td></td><td></td>";
                    }
                }
                bodyHtml += "</tr>";
                });

                // Ieliekam tabulu konteinerā
                const tableHtml = `<table border="1" cellspacing="0" cellpadding="4">${headerHtml}${bodyHtml}</table>`;
                document.getElementById("tree-table").innerHTML = tableHtml;
            }
            // Funkcija, kas no teksta izvelk nosaukumu un ID, ja tas ir iekavās beigās
                function splitNameAndId(text) {
                const idMatch = text.match(/[\(\[]([^)\]]+)[\)\]]$/); // Meklē tekstu iekavās vai kvadrātiekavās beigās
                const id = idMatch ? idMatch[1] : '';
                const name = id ? text.slice(0, idMatch.index).trim() : text.trim();
                return { name, id };
                }
            // Kad fancytree ir inicializēts, izsauc funkciju
            $(function() {
                const tree = $("#tree").fancytree("getTree");
                buildTableFromTree(tree);

                // Vari šo funkciju pievienot arī pogai, lai atsvaidzinātu tabulu pēc izmaiņām
                $("#save-server").click(function() {
                buildTableFromTree(tree);
                // pēc tam arī sūti uz serveri vai ko citu
                });



            
            });
        
  </script>

</body>
</html>